rules:
  - id: hardcoded-secret-string
    patterns:
      - pattern: $VAR = "..."
      - metavariable-regex:
          metavariable: $VAR
          regex: .*(api_key|secret|password|token|auth).*
    message: >-
      Hardcoded secret in `$VAR`. Move to an environment variable or secrets manager.
    severity: ERROR
    languages: [python]
    metadata:
      category: security

  - id: sql-fstring-injection
    patterns:
      - pattern-either:
          - pattern: $CURSOR.execute(f"...")
          - pattern: $CURSOR.execute(f'...')
          - pattern: $CURSOR.query(f"...")
          - pattern: $CURSOR.query(f'...')
    message: >-
      SQL query built with f-string — use parameterized queries to prevent injection.
    severity: ERROR
    languages: [python]
    metadata:
      category: security

  - id: bare-except-swallows-errors
    patterns:
      - pattern: |
          try:
              ...
          except:
              pass
    message: >-
      Bare `except: pass` silently swallows all errors including KeyboardInterrupt.
      Catch a specific exception and log the error.
    severity: WARNING
    languages: [python]
    metadata:
      category: correctness

  - id: unchecked-requests-response
    patterns:
      - pattern: $RESP = requests.$METHOD(...)
      - pattern-not-inside: |
          ...
          $RESP.raise_for_status()
          ...
      - pattern-not-inside: |
          ...
          $RESP.status_code
          ...
      - metavariable-regex:
          metavariable: $METHOD
          regex: ^(get|post|put|patch|delete)$
    message: >-
      HTTP response from `requests.$METHOD()` is not checked — call
      `.raise_for_status()` or inspect `.status_code`.
    severity: WARNING
    languages: [python]
    metadata:
      category: correctness

  - id: open-without-context-manager
    patterns:
      - pattern: $FH = open(...)
      - pattern-not-inside: |
          with ... as $FH:
              ...
    message: >-
      `open()` without a context manager — use `with open(...) as f:` to ensure
      the file is closed.
    severity: WARNING
    languages: [python]
    metadata:
      category: correctness

  - id: subprocess-shell-true
    patterns:
      - pattern-either:
          - pattern: subprocess.run(..., shell=True, ...)
          - pattern: subprocess.call(..., shell=True, ...)
          - pattern: subprocess.Popen(..., shell=True, ...)
          - pattern: subprocess.check_output(..., shell=True, ...)
          - pattern: subprocess.check_call(..., shell=True, ...)
    message: >-
      `shell=True` is a command injection risk — pass a list of args instead.
    severity: ERROR
    languages: [python]
    metadata:
      category: security

  - id: eval-or-exec-usage
    pattern-either:
      - pattern: eval(...)
      - pattern: exec(...)
    message: >-
      `eval()`/`exec()` can execute arbitrary code — avoid or restrict input.
    severity: ERROR
    languages: [python]
    metadata:
      category: security

  - id: mutable-default-argument
    patterns:
      - pattern-either:
          - pattern: |
              def $FUNC(..., $ARG=[], ...):
                  ...
          - pattern: |
              def $FUNC(..., $ARG={}, ...):
                  ...
    message: >-
      Mutable default argument `$ARG` is shared across calls — use `None`
      and assign inside the function body.
    severity: WARNING
    languages: [python]
    metadata:
      category: correctness

  - id: assert-used-for-validation
    pattern: assert ...
    paths:
      exclude:
        - "*test*"
        - "*spec*"
    message: >-
      `assert` is stripped in optimized mode (`-O`) — use `if`/`raise`
      for runtime validation.
    severity: WARNING
    languages: [python]
    metadata:
      category: correctness
